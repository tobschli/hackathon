name: Close Hackathon Voting

on:
  workflow_dispatch:
    inputs:
      hackathon_label:
        description: 'Label to filter hackathon topic issues (e.g., hackathon-2025-autumn)'
        required: true
        type: string
      discussion_number:
        description: 'Discussion number to update with voting results'
        required: true
        type: string

permissions:
  contents: read
  issues: write
  discussions: write

jobs:
  close-voting:
    runs-on: ubuntu-latest
    steps:
      - name: Count votes and update discussion
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DISCUSSION_TOKEN }}
          script: |
            const label = '${{ inputs.hackathon_label }}';
            const discussionNumber = parseInt('${{ inputs.discussion_number }}');
            
            // Get discussion and its comments with reactions
            const discussionQuery = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  discussion(number: $number) {
                    id
                    comments(first: 100) {
                      nodes {
                        id
                        body
                        reactions(first: 100) {
                          nodes {
                            content
                            user {
                              login
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const discussionResult = await github.graphql(discussionQuery, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: discussionNumber
            });
            
            if (!discussionResult.repository.discussion) {
              throw new Error(`Discussion #${discussionNumber} not found`);
            }
            
            const discussion = discussionResult.repository.discussion;
            const comments = discussion.comments.nodes;
            
            console.log(`Found ${comments.length} comments in discussion`);
            
            // Parse voting comments and count votes
            const issueVotes = [];
            const issueAssignees = [];
            
            for (const comment of comments) {
              // Check if this is a topic voting comment
              const match = comment.body.match(/<!-- hackathon-topic-vote:(\d+) -->/);
              if (!match) continue;
              
              const issueNumber = parseInt(match[1]);
              const reactions = comment.reactions.nodes;
              
              // Count votes (thumbs up)
              const votes = reactions.filter(r => r.content === 'THUMBS_UP').length;
              
              // Get users who want to work on this (rocket)
              const assignees = reactions
                .filter(r => r.content === 'ROCKET')
                .map(r => r.user.login);
              
              // Get issue details
              let issueTitle = `Issue #${issueNumber}`;
              let issueUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issueNumber}`;
              
              try {
                const issueData = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });
                issueTitle = issueData.data.title;
                issueUrl = issueData.data.html_url;
              } catch (error) {
                console.log(`Warning: Could not fetch issue #${issueNumber}`);
              }
              
              issueVotes.push({
                number: issueNumber,
                title: issueTitle,
                url: issueUrl,
                votes: votes,
                assignees: assignees
              });
              
              if (assignees.length > 0) {
                issueAssignees.push({
                  issueNumber: issueNumber,
                  assignees: assignees
                });
              }
              
              console.log(`Issue #${issueNumber}: ${votes} votes, ${assignees.length} assignees`);
            }
            
            // Sort by votes descending
            issueVotes.sort((a, b) => b.votes - a.votes);
            
            // Build results body
            let resultsBody = `# ðŸ† Hackathon Topic Voting Results\n\n`;
            resultsBody += `Voting has closed! Here are the results:\n\n`;
            resultsBody += `## ðŸ“Š Ranked Topics\n\n`;
            resultsBody += `| Rank | Topic | Votes | Team |\n`;
            resultsBody += `|:----:|:------|:-----:|:-----|\n`;
            
            issueVotes.forEach((issue, index) => {
              let medal = '';
              if (index === 0) medal = 'ðŸ¥‡ ';
              else if (index === 1) medal = 'ðŸ¥ˆ ';
              else if (index === 2) medal = 'ðŸ¥‰ ';
              
              const team = issue.assignees.length > 0 
                ? issue.assignees.map(a => `@${a}`).join(', ')
                : '-';
              
              resultsBody += `| ${medal}${index + 1} | [#${issue.number} - ${issue.title}](${issue.url}) | ${issue.votes} | ${team} |\n`;
            });
            
            resultsBody += `\n---\n`;
            resultsBody += `*Thank you for participating! Team members have been assigned to their respective issues.*\n`;
            
            // Update the discussion body with results
            const updateMutation = `
              mutation($discussionId: ID!, $body: String!) {
                updateDiscussion(input: {discussionId: $discussionId, body: $body}) {
                  discussion {
                    id
                    url
                  }
                }
              }
            `;
            
            await github.graphql(updateMutation, {
              discussionId: discussion.id,
              body: resultsBody
            });
            
            console.log(`Updated discussion #${discussionNumber} with voting results`);
            
            // Assign users to issues based on ðŸš€ reactions
            for (const item of issueAssignees) {
              try {
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: item.issueNumber,
                  assignees: item.assignees
                });
                console.log(`Assigned ${item.assignees.join(', ')} to issue #${item.issueNumber}`);
              } catch (error) {
                console.log(`Warning: Could not assign users to issue #${item.issueNumber}: ${error.message}`);
              }
            }
            
            console.log('Voting closed successfully!');
