name: Close Hackathon Voting

on:
  workflow_dispatch:
    inputs:
      hackathon_label:
        description: 'Label to filter hackathon topic issues (e.g., hackathon-2025-autumn)'
        required: true
        type: string
      discussion_number:
        description: 'Discussion number to update with voting results'
        required: true
        type: string

permissions:
  contents: read
  issues: write
  discussions: write

jobs:
  close-voting:
    runs-on: ubuntu-latest
    steps:
      - name: Count votes and update discussion
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DISCUSSION_TOKEN }}
          script: |
            const label = '${{ inputs.hackathon_label }}';
            const discussionNumber = parseInt('${{ inputs.discussion_number }}');
            
            // Get all open issues with the label
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: label,
              per_page: 100
            });
            
            // Filter out PRs
            const topicIssues = issues.filter(issue => !issue.pull_request);
            
            if (topicIssues.length === 0) {
              console.log('No issues found with label:', label);
              return;
            }
            
            console.log(`Found ${topicIssues.length} topic issues`);
            
            // Count votes for each issue and collect voting comment IDs
            const issueVotes = [];
            const votingCommentIds = [];
            
            for (const issue of topicIssues) {
              // Get all comments on the issue
              const comments = await github.paginate(github.rest.issues.listComments, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                per_page: 100
              });
              
              // Find the voting comment
              const votingComment = comments.find(c => 
                c.body && c.body.includes('<!-- hackathon-voting-comment -->')
              );
              
              let votes = 0;
              if (votingComment) {
                // Store comment ID for deletion later
                votingCommentIds.push({
                  issueNumber: issue.number,
                  commentId: votingComment.id
                });
                
                // Get reactions on the voting comment
                const reactions = await github.paginate(github.rest.reactions.listForIssueComment, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: votingComment.id,
                  per_page: 100
                });
                
                // Count thumbs up reactions
                votes = reactions.filter(r => r.content === '+1').length;
              }
              
              issueVotes.push({
                number: issue.number,
                title: issue.title,
                url: issue.html_url,
                votes: votes
              });
              
              console.log(`Issue #${issue.number}: ${issue.title} - ${votes} votes`);
            }
            
            // Sort by votes descending
            issueVotes.sort((a, b) => b.votes - a.votes);
            
            // Build results body
            let resultsBody = `# ðŸ† Hackathon Topic Voting Results\n\n`;
            resultsBody += `Voting has closed! Here are the results:\n\n`;
            resultsBody += `## ðŸ“Š Ranked Topics\n\n`;
            resultsBody += `| Rank | Topic | Votes |\n`;
            resultsBody += `|:----:|:------|:-----:|\n`;
            
            issueVotes.forEach((issue, index) => {
              let medal = '';
              if (index === 0) medal = 'ðŸ¥‡ ';
              else if (index === 1) medal = 'ðŸ¥ˆ ';
              else if (index === 2) medal = 'ðŸ¥‰ ';
              
              resultsBody += `| ${medal}${index + 1} | [#${issue.number} - ${issue.title}](${issue.url}) | ${issue.votes} |\n`;
            });
            
            resultsBody += `\n---\n`;
            resultsBody += `*Thank you for voting! Teams will be formed based on these results and participant preferences.*\n`;
            
            // Get discussion ID
            const discussionQuery = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  discussion(number: $number) {
                    id
                  }
                }
              }
            `;
            
            const discussionResult = await github.graphql(discussionQuery, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: discussionNumber
            });
            
            if (!discussionResult.repository.discussion) {
              throw new Error(`Discussion #${discussionNumber} not found`);
            }
            
            const discussionId = discussionResult.repository.discussion.id;
            
            // Update the discussion body with results
            const updateMutation = `
              mutation($discussionId: ID!, $body: String!) {
                updateDiscussion(input: {discussionId: $discussionId, body: $body}) {
                  discussion {
                    id
                    url
                  }
                }
              }
            `;
            
            await github.graphql(updateMutation, {
              discussionId: discussionId,
              body: resultsBody
            });
            
            console.log(`Updated discussion #${discussionNumber} with voting results`);
            
            // Delete voting comments from all issues
            for (const item of votingCommentIds) {
              try {
                // Unpin the comment first
                await github.request('DELETE /repos/{owner}/{repo}/issues/comments/{comment_id}/pin', {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: item.commentId,
                  headers: {
                    'X-GitHub-Api-Version': '2022-11-28'
                  }
                });
              } catch (error) {
                // Ignore unpin errors (comment might not be pinned)
              }
              
              // Delete the comment
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: item.commentId
              });
              
              console.log(`Deleted voting comment from issue #${item.issueNumber}`);
            }
            
            console.log('Voting closed successfully!');
