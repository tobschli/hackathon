name: Start Hackathon Voting

on:
  workflow_dispatch:
    inputs:
      hackathon_label:
        description: 'Label to filter hackathon topic issues (e.g., hackathon-2025-autumn)'
        required: true
        type: string
      discussion_category:
        description: 'Discussion category to create the voting discussion in'
        required: false
        default: 'General'
        type: string

permissions:
  contents: read
  issues: write
  discussions: write

jobs:
  start-voting:
    runs-on: ubuntu-latest
    steps:
      - name: Add voting comments and create discussion
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DISCUSSION_TOKEN }}
          script: |
            const label = '${{ inputs.hackathon_label }}';
            const category = '${{ inputs.discussion_category }}';
            const votingMarker = '<!-- hackathon-voting-comment -->';
            
            // Get all open issues with the label
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: label,
              per_page: 100
            });
            
            // Filter out PRs
            const topicIssues = issues.filter(issue => !issue.pull_request);
            
            if (topicIssues.length === 0) {
              console.log('No issues found with label:', label);
              return;
            }
            
            console.log(`Found ${topicIssues.length} topic issues`);
            
            // Add voting comment to each issue and pin it
            for (const issue of topicIssues) {
              // Check if voting comment already exists
              const comments = await github.paginate(github.rest.issues.listComments, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                per_page: 100
              });
              
              const existingVotingComment = comments.find(c => c.body && c.body.includes(votingMarker));
              
              if (existingVotingComment) {
                console.log(`Voting comment already exists on issue #${issue.number}`);
                continue;
              }
              
              // Create voting comment
              const commentBody = votingMarker + '\n\n' +
                '## üó≥Ô∏è Vote for this Topic!\n\n' +
                "If you're interested in working on this topic during the hackathon, please react to this comment with a üëç (thumbs up) emoji.\n\n" +
                '**How to vote:**\n' +
                '1. Click the smiley face icon below this comment\n' +
                '2. Select the üëç reaction\n\n' +
                'The topics with the most votes will help us prioritize and form teams!\n\n' +
                '---\n' +
                '*This is an automated voting comment. Votes are counted based on üëç reactions to this comment.*';
              
              const comment = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: commentBody
              });
              
              console.log(`Added voting comment to issue #${issue.number}`);
              
              // Pin the comment using the REST API
              try {
                await github.request('PUT /repos/{owner}/{repo}/issues/comments/{comment_id}/pin', {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.data.id,
                  headers: {
                    'X-GitHub-Api-Version': '2022-11-28'
                  }
                });
                console.log(`Pinned voting comment on issue #${issue.number}`);
              } catch (error) {
                console.log(`Warning: Could not pin comment on issue #${issue.number}: ${error.message}`);
              }
            }

            // Build discussion body
            let body = `# üó≥Ô∏è Hackathon Topic Voting\n\n`;
            body += `Vote for the topics you're interested in! Go to each issue and react with üëç on the pinned voting comment.\n\n`;
            body += `## üìã Topics\n\n`;
            
            for (const issue of topicIssues) {
              body += `- [#${issue.number} - ${issue.title}](${issue.html_url})\n`;
            }

            body += `\n---\n`;
            body += `*Voting results will be posted here once voting closes.*\n`;
            body += `\n<!-- hackathon-voting-discussion -->\n`;
            body += `<!-- label: ${label} -->\n`;

            // Get discussion categories
            const query = `
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  discussionCategories(first: 20) {
                    nodes {
                      id
                      name
                    }
                  }
                }
              }
            `;
            
            const result = await github.graphql(query, {
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const categoryNode = result.repository.discussionCategories.nodes.find(
              c => c.name.toLowerCase() === category.toLowerCase()
            );
            
            if (!categoryNode) {
              console.log('Available categories:', result.repository.discussionCategories.nodes.map(c => c.name));
              throw new Error(`Discussion category "${category}" not found`);
            }

            // Get repository ID
            const repoQuery = `
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  id
                }
              }
            `;
            
            const repoResult = await github.graphql(repoQuery, {
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // Create discussion
            const createMutation = `
              mutation($repositoryId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
                createDiscussion(input: {repositoryId: $repositoryId, categoryId: $categoryId, title: $title, body: $body}) {
                  discussion {
                    id
                    number
                    url
                  }
                }
              }
            `;
            
            const discussion = await github.graphql(createMutation, {
              repositoryId: repoResult.repository.id,
              categoryId: categoryNode.id,
              title: `üó≥Ô∏è Hackathon Topic Voting - ${label}`,
              body: body
            });
            
            console.log('Created discussion:', discussion.createDiscussion.discussion.url);
            
            // Output discussion URL
            core.setOutput('discussion_url', discussion.createDiscussion.discussion.url);
            core.setOutput('discussion_id', discussion.createDiscussion.discussion.id);
