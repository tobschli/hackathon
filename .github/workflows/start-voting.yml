name: Start Hackathon Voting

on:
  workflow_dispatch:
    inputs:
      hackathon_label:
        description: 'Label to filter hackathon topic issues (e.g., hackathon-2025-autumn)'
        required: true
        type: string
      discussion_category:
        description: 'Discussion category to create the voting discussion in'
        required: false
        default: 'General'
        type: string

permissions:
  contents: read
  issues: write
  discussions: write

jobs:
  start-voting:
    runs-on: ubuntu-latest
    steps:
      - name: Create voting discussion with topic comments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DISCUSSION_TOKEN }}
          script: |
            const label = '${{ inputs.hackathon_label }}';
            const category = '${{ inputs.discussion_category }}';
            
            // Get all open issues with the label
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: label,
              per_page: 100
            });
            
            // Filter out PRs
            const topicIssues = issues.filter(issue => !issue.pull_request);
            
            if (topicIssues.length === 0) {
              console.log('No issues found with label:', label);
              return;
            }
            
            console.log(`Found ${topicIssues.length} topic issues`);
            
            // Build discussion body
            let body = `# üó≥Ô∏è Hackathon Topic Voting\n\n`;
            body += `Vote for the topics you're interested in!\n\n`;
            body += `**How to participate:**\n`;
            body += `- üëç = I want this topic to happen (vote)\n`;
            body += `- üöÄ = I want to work on this topic (you'll be assigned when voting closes)\n\n`;
            body += `Each topic has its own comment below. React to the topics you're interested in!\n\n`;
            body += `## üìã Topics\n\n`;
            
            for (const issue of topicIssues) {
              body += `- [#${issue.number} - ${issue.title}](${issue.html_url})\n`;
            }
            
            body += `\n---\n`;
            body += `*Voting results will be posted here once voting closes.*\n`;
            body += `\n<!-- hackathon-voting-discussion -->\n`;
            body += `<!-- label: ${label} -->\n`;
            
            // Get discussion categories
            const query = `
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  discussionCategories(first: 20) {
                    nodes {
                      id
                      name
                    }
                  }
                }
              }
            `;
            
            const result = await github.graphql(query, {
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const categoryNode = result.repository.discussionCategories.nodes.find(
              c => c.name.toLowerCase() === category.toLowerCase()
            );
            
            if (!categoryNode) {
              console.log('Available categories:', result.repository.discussionCategories.nodes.map(c => c.name));
              throw new Error(`Discussion category "${category}" not found`);
            }
            
            // Get repository ID
            const repoQuery = `
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  id
                }
              }
            `;
            
            const repoResult = await github.graphql(repoQuery, {
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // Create discussion
            const createMutation = `
              mutation($repositoryId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
                createDiscussion(input: {repositoryId: $repositoryId, categoryId: $categoryId, title: $title, body: $body}) {
                  discussion {
                    id
                    number
                    url
                  }
                }
              }
            `;
            
            const discussion = await github.graphql(createMutation, {
              repositoryId: repoResult.repository.id,
              categoryId: categoryNode.id,
              title: `üó≥Ô∏è Hackathon Topic Voting - ${label}`,
              body: body
            });
            
            console.log('Created discussion:', discussion.createDiscussion.discussion.url);
            
            const discussionId = discussion.createDiscussion.discussion.id;
            
            // Add a comment for each topic issue
            for (const issue of topicIssues) {
              const commentBody = `<!-- hackathon-topic-vote:${issue.number} -->\n\n` +
                `## [#${issue.number} - ${issue.title}](${issue.html_url})\n\n` +
                (issue.body ? issue.body.substring(0, 500) + (issue.body.length > 500 ? '...' : '') : '_No description provided._') + `\n\n` +
                `---\n` +
                `**React to vote:**\n` +
                `- üëç = I want this topic to happen\n` +
                `- üöÄ = I want to work on this topic`;
              
              const addCommentMutation = `
                mutation($discussionId: ID!, $body: String!) {
                  addDiscussionComment(input: {discussionId: $discussionId, body: $body}) {
                    comment {
                      id
                    }
                  }
                }
              `;
              
              await github.graphql(addCommentMutation, {
                discussionId: discussionId,
                body: commentBody
              });
              
              console.log(`Added voting comment for issue #${issue.number}`);
            }
            
            console.log('Voting discussion created successfully!');
            core.setOutput('discussion_url', discussion.createDiscussion.discussion.url);
            core.setOutput('discussion_number', discussion.createDiscussion.discussion.number);
